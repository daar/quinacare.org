---
import LanguageSwitcher from "./LanguageSwitcher.astro";
import {
  getLangFromUrl,
  useTranslations,
  getLocalizedPath,
  type TranslationKey,
} from "../i18n";
import menuData from "../data/menus.json";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const tk = (key: string) => t(key as TranslationKey);

const searchPath = getLocalizedPath("/search", lang);
---

<nav
  class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm border-b border-gray-100 h-20"
>
  <div
    class="max-w-[1600px] mx-auto px-6 h-full flex items-center justify-between gap-4"
  >
    <div class="flex items-center gap-8">
      <a href={getLocalizedPath("/", lang)}>
        <img
          src="/logo-quina-care.svg"
          alt="Quina Care"
          class="w-10 max-w-none"
        />
      </a>
      <div
        class="hidden xl:flex items-center gap-3 border-l border-gray-200 pl-8"
      >
        <img
          src="https://destiel.org/wp-content/uploads/2025/02/Certified-Nonprofit.png"
          alt="Certified Nonprofit"
          class="h-12"
        />
        <img
          src="https://wijzijnmind.nl/uploads/media/max-width/04/5944-anbi-algemeen-nut-beogende-instelling.png"
          alt="ANBI"
          class="h-12"
        />
        <img
          src="https://cbf.nl/media/pages/medialibrary/6e14d21c84-1713514483/logo_erkend_goed_doel_rgb.png"
          alt="CBF"
          class="h-12"
        />
      </div>
    </div>

    {/* Desktop navigation */}
    <div
      class="hidden lg:flex gap-10 text-[11px] font-bold uppercase tracking-[0.15em]"
    >
      {
        menuData.items.map((item) =>
          item.submenu ? (
            <div class="group relative">
              <button
                class="flex items-center gap-1.5 hover:text-qcRed transition cursor-pointer"
                aria-expanded="false"
                aria-haspopup="true"
              >
                {tk(item.labelKey)}
                <svg
                  class="w-3 h-3 transition-transform duration-200 group-hover:rotate-180"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-width="2.5" d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              <div class="submenu-dropdown absolute top-full left-1/2 -translate-x-1/2 pt-4 w-80">
                <div class="bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden">
                  {/* Simple list items (no image) */}
                  <div class="p-2">
                    {item.submenu
                      .filter((sub) => !sub.image)
                      .map((sub) => (
                        <a
                          href={getLocalizedPath(sub.path, lang)}
                          class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 transition group/item"
                        >
                          <i
                            class={`${sub.icon} text-gray-400 group-hover/item:text-qcRed transition w-5 text-center`}
                          />
                          <span class="text-[11px] font-bold uppercase tracking-[0.12em] group-hover/item:text-qcRed transition">
                            {tk(sub.labelKey)}
                          </span>
                        </a>
                      ))}
                  </div>

                  {/* Featured items (with image) */}
                  {item.submenu.some((sub) => sub.image) && (
                    <div class="border-t border-gray-100 p-2 space-y-1">
                      {item.submenu
                        .filter((sub) => sub.image)
                        .map((sub) => (
                          <a
                            href={getLocalizedPath(sub.path, lang)}
                            class="block rounded-lg overflow-hidden transition group/item"
                          >
                            <div class="relative">
                              <img
                                src={sub.image}
                                alt=""
                                class="w-full h-36 object-cover bg-gray-100"
                              />
                              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
                              <div class="absolute bottom-0 left-0 right-0 p-3 flex items-center gap-2">
                                <span class="w-7 h-7 rounded-full bg-qcRed flex items-center justify-center flex-shrink-0">
                                  <i class="fa-solid fa-arrow-right text-white text-[10px] group-hover/item:animate-[submenuPulse_0.4s_ease] will-change-transform" />
                                </span>
                                <span class="text-[11px] font-bold uppercase tracking-[0.12em] text-white">
                                  {tk(sub.labelKey)}
                                </span>
                              </div>
                            </div>
                            {sub.descriptionKey && (
                              <p class="px-3 py-2 text-[10px] text-gray-400 leading-snug normal-case tracking-normal font-normal line-clamp-2">
                                {tk(sub.descriptionKey)}
                              </p>
                            )}
                          </a>
                        ))}
                    </div>
                  )}

                  {/* CTA button */}
                  {item.cta && (
                    <div class="border-t border-gray-100 p-2">
                      <a
                        href={getLocalizedPath(item.cta.path, lang)}
                        class="flex items-center justify-center gap-2 bg-qcRed text-white px-4 py-2.5 rounded-lg font-bold text-[11px] uppercase tracking-[0.15em] hover:bg-qcBlack transition"
                      >
                        <i class={item.cta.icon} />
                        {tk(item.cta.labelKey)}
                      </a>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ) : item.path ? (
            <a
              href={getLocalizedPath(item.path, lang)}
              class="hover:text-qcRed transition"
            >
              {tk(item.labelKey)}
            </a>
          ) : (
            <a href="#" class="hover:text-qcRed transition">
              {tk(item.labelKey)}
            </a>
          ),
        )
      }
    </div>

    <div class="flex items-center gap-6">
      {/* Default state: search icon + language switcher */}
      <div
        id="nav-default"
        class="flex items-center gap-4 text-[11px] font-bold uppercase tracking-widest lg:border-r lg:border-gray-200 lg:pr-6 lg:mr-2"
      >
        <button
          id="search-open-btn"
          class="text-gray-400 hover:text-qcRed text-sm"
          aria-label={t("search.title")}
        >
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <div class="hidden lg:flex">
          <LanguageSwitcher />
        </div>
      </div>

      {/* Expanded search state (hidden by default) */}
      <div
        id="nav-search"
        class="hidden items-center gap-3 border-r border-gray-200 pr-6 mr-2 search-expand-enter"
        data-search-path={searchPath}
        data-placeholder={t("search.placeholder")}
        data-no-results={t("search.noResults")}
        data-see-all={t("search.seeAll")}
        data-results-label={t("search.results")}
      >
        <i class="fa-solid fa-magnifying-glass text-gray-400 text-sm"></i>
        <input
          id="search-input"
          type="text"
          placeholder={t("search.placeholder")}
          class="bg-transparent outline-none text-sm w-48 md:w-64"
          autocomplete="off"
        />
        <button
          id="search-close-btn"
          class="text-gray-400 hover:text-qcBlack text-sm"
          aria-label="Close search"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      {/* Donate button */}
      <a
        id="nav-donate-btn"
        href={getLocalizedPath("/donate", lang)}
        class="bg-qcRed text-white px-4 lg:px-7 py-3 rounded-md font-bold text-[11px] uppercase tracking-[0.2em] hover:bg-qcBlack transition-all shadow-md flex-shrink-0 whitespace-nowrap"
      >
        <i class="fa-solid fa-heart transition-transform group-hover:scale-125"
        ></i>
        <span class="hidden lg:inline">{t("nav.donate")}</span>
        <span class="lg:hidden">{t("nav.donate").split(" ")[0]}</span>
      </a>

      {/* Hamburger button (mobile only) */}
      <button
        id="hamburger-btn"
        class="lg:hidden text-gray-600 hover:text-qcRed text-lg w-5 text-center"
        aria-label="Menu"
        aria-expanded="false"
      >
        <i class="fa-solid fa-bars"></i>
      </button>
    </div>
  </div>

  {/* Search dropdown */}
  <div
    id="search-dropdown"
    class="hidden absolute left-0 right-0 top-full bg-white border-b border-gray-200 shadow-lg search-dropdown-enter"
  >
    <div class="max-w-[1600px] mx-auto px-6 py-6">
      <div id="search-results-list" class="space-y-4"></div>
      <div id="search-no-results" class="hidden text-center py-8">
        <p class="text-gray-400 text-sm">{t("search.noResults")}</p>
      </div>
      <div id="search-start" class="hidden text-center py-8">
        <p class="text-gray-400 text-sm">{t("search.startTyping")}</p>
      </div>
      <a
        id="search-see-all"
        href="#"
        class="hidden mt-4 pt-4 border-t border-gray-100 text-[11px] font-bold uppercase tracking-widest text-qcRed hover:text-qcBlack transition items-center gap-2"
      >
        <span id="search-see-all-text"></span>
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
        </svg>
      </a>
    </div>
  </div>

  {/* Backdrop */}
  <div
    id="search-backdrop"
    class="hidden fixed inset-0 top-20 bg-black/20 z-[-1]"
  >
  </div>

  {/* Mobile menu panel */}
  <div
    id="mobile-menu"
    class="hidden fixed inset-x-0 top-20 z-40 bg-white border-b border-gray-200 shadow-lg lg:hidden max-h-[calc(100dvh-5rem)] overflow-y-auto"
  >
    <div class="mobile-menu-slider">
      {/* Main menu level */}
      <div class="mobile-menu-main flex flex-col px-6 py-4">
        {
          menuData.items.map((item) =>
            item.submenu ? (
              <button
                class="mobile-submenu-trigger w-full flex items-center justify-between py-3 text-base font-bold uppercase tracking-widest hover:text-qcRed transition"
                data-submenu={item.id}
              >
                {tk(item.labelKey)}
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-width="2.5" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            ) : item.path ? (
              <a
                href={getLocalizedPath(item.path, lang)}
                class="mobile-menu-link py-3 text-base font-bold uppercase tracking-widest hover:text-qcRed transition"
              >
                {tk(item.labelKey)}
              </a>
            ) : (
              <a
                href="#"
                class="mobile-menu-link py-3 text-base font-bold uppercase tracking-widest hover:text-qcRed transition"
              >
                {tk(item.labelKey)}
              </a>
            ),
          )
        }
        <div class="border-t border-gray-200 mt-2 pt-4 pb-2">
          <LanguageSwitcher />
        </div>
      </div>

      {/* Submenu panels (one per menu item with submenu) */}
      {
        menuData.items
          .filter((item) => item.submenu)
          .map((item) => (
            <div
              class="mobile-submenu-panel flex flex-col px-6 py-4"
              data-submenu-panel={item.id}
            >
              <button class="mobile-back-btn flex items-center gap-2 py-3 text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-qcBlack transition">
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path stroke-width="2.5" d="M15 19l-7-7 7-7" />
                </svg>
                {tk(item.labelKey)}
              </button>
              <div class="space-y-1 mt-1">
                {item.submenu!.map((sub) =>
                  sub.image ? (
                    <a
                      href={getLocalizedPath(sub.path, lang)}
                      class="mobile-menu-link block rounded-lg overflow-hidden transition group/mitem"
                    >
                      <div class="relative mt-1">
                        <img
                          src={sub.image}
                          alt=""
                          class="w-full h-44 object-cover bg-gray-100 rounded-lg"
                        />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent rounded-lg" />
                        <div class="absolute bottom-0 left-0 right-0 p-4 flex items-center gap-2.5">
                          <span class="w-8 h-8 rounded-full bg-qcRed flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-arrow-right text-white text-xs submenu-arrow will-change-transform" />
                          </span>
                          <span class="text-sm font-bold uppercase tracking-widest text-white">
                            {tk(sub.labelKey)}
                          </span>
                        </div>
                      </div>
                      {sub.descriptionKey && (
                        <p class="py-2 text-xs text-gray-400 leading-snug normal-case tracking-normal font-normal">
                          {tk(sub.descriptionKey)}
                        </p>
                      )}
                    </a>
                  ) : (
                    <a
                      href={getLocalizedPath(sub.path, lang)}
                      class="mobile-menu-link flex items-center gap-3 py-2.5 rounded-lg hover:bg-gray-50 transition px-1"
                    >
                      <i
                        class={`${sub.icon} text-gray-400 w-5 text-center text-sm`}
                      />
                      <span class="text-sm font-bold uppercase tracking-widest">
                        {tk(sub.labelKey)}
                      </span>
                    </a>
                  ),
                )}
                {item.cta && (
                  <a
                    href={getLocalizedPath(item.cta.path, lang)}
                    class="mobile-menu-link flex items-center justify-center gap-2 bg-qcRed text-white px-4 py-2.5 rounded-lg font-bold text-xs uppercase tracking-widest hover:bg-qcBlack transition mt-2"
                  >
                    <i class={item.cta.icon} />
                    {tk(item.cta.labelKey)}
                  </a>
                )}
              </div>
            </div>
          ))
      }
    </div>
  </div>

  {/* Mobile menu backdrop */}
  <div
    id="mobile-menu-backdrop"
    class="hidden fixed inset-0 top-20 bg-black/20 z-30 lg:hidden"
  >
  </div>
</nav>

<script>
  /* eslint-disable @typescript-eslint/no-explicit-any */
  document.addEventListener("DOMContentLoaded", () => {
    const navDefault = document.getElementById("nav-default");
    const navSearch = document.getElementById("nav-search");
    const searchInput = document.getElementById(
      "search-input",
    ) as HTMLInputElement;
    const openBtn = document.getElementById("search-open-btn");
    const closeBtn = document.getElementById("search-close-btn");
    const donateBtn = document.getElementById("nav-donate-btn");
    const dropdown = document.getElementById("search-dropdown");
    const backdrop = document.getElementById("search-backdrop");
    const resultsList = document.getElementById("search-results-list");
    const noResults = document.getElementById("search-no-results");
    const searchStart = document.getElementById("search-start");
    const seeAllLink = document.getElementById(
      "search-see-all",
    ) as HTMLAnchorElement;
    const seeAllText = document.getElementById("search-see-all-text");

    if (!navDefault || !navSearch || !searchInput || !dropdown) return;

    const searchPath = navSearch.dataset.searchPath || "/search";
    const seeAllMsg = navSearch.dataset.seeAll || "See all results";
    const resultsLabel = navSearch.dataset.resultsLabel || "results";

    let pagefind: any = null;
    let debounceTimer: ReturnType<typeof setTimeout>;

    async function loadPagefind() {
      if (pagefind) return pagefind;
      try {
        const path = "/pagefind/pagefind.js";
        pagefind = await import(/* @vite-ignore */ path);
        await pagefind.init({
          language: document.documentElement.lang,
        });
        return pagefind;
      } catch {
        return null;
      }
    }

    function openSearch() {
      navDefault!.classList.add("hidden");
      donateBtn?.classList.add("hidden");
      navSearch!.classList.remove("hidden");
      navSearch!.classList.add("flex");
      searchInput!.focus();
      searchStart?.classList.remove("hidden");
      dropdown!.classList.remove("hidden");
      backdrop?.classList.remove("hidden");
    }

    function closeSearch() {
      navSearch!.classList.add("hidden");
      navSearch!.classList.remove("flex");
      navDefault!.classList.remove("hidden");
      donateBtn?.classList.remove("hidden");
      dropdown!.classList.add("hidden");
      backdrop?.classList.add("hidden");
      searchInput!.value = "";
      if (resultsList) resultsList.innerHTML = "";
      noResults?.classList.add("hidden");
      searchStart?.classList.add("hidden");
      seeAllLink?.classList.add("hidden");
      seeAllLink?.classList.remove("flex");
    }

    function navigateToSearch(query: string) {
      if (query.trim()) {
        window.location.href = `${searchPath}?q=${encodeURIComponent(query.trim())}`;
      }
    }

    async function doSearch(query: string) {
      const pf = await loadPagefind();
      if (!pf) return;

      if (query.length < 2) {
        if (resultsList) resultsList.innerHTML = "";
        noResults?.classList.add("hidden");
        searchStart?.classList.remove("hidden");
        seeAllLink?.classList.add("hidden");
        seeAllLink?.classList.remove("flex");
        return;
      }

      searchStart?.classList.add("hidden");

      const search = await pf.search(query);

      if (search.results.length === 0) {
        if (resultsList) resultsList.innerHTML = "";
        noResults?.classList.remove("hidden");
        seeAllLink?.classList.add("hidden");
        seeAllLink?.classList.remove("flex");
        return;
      }

      noResults?.classList.add("hidden");

      const top5 = search.results.slice(0, 5);
      const dataPromises = top5.map((r: any) => r.data());
      const items = await Promise.all(dataPromises);

      if (resultsList) {
        resultsList.innerHTML = items
          .map(
            (item: any) => `
          <a href="${item.url}" class="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50 transition group">
            ${
              item.meta?.image
                ? `<img src="${item.meta.image}" alt="" class="w-16 h-16 object-cover rounded-lg bg-gray-100 flex-shrink-0" />`
                : `<div class="w-16 h-16 rounded-lg bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-file-lines text-gray-300"></i>
                  </div>`
            }
            <div class="min-w-0 flex-1">
              <h4 class="text-sm font-bold uppercase tracking-tight group-hover:text-qcRed transition truncate">${item.meta?.title || ""}</h4>
              <p class="text-xs text-gray-400 line-clamp-1 mt-1">${item.excerpt || ""}</p>
            </div>
          </a>
        `,
          )
          .join("");
      }

      if (search.results.length > 5 && seeAllLink && seeAllText) {
        seeAllText.textContent = `${seeAllMsg} (${search.results.length} ${resultsLabel}) â†’`;
        seeAllLink.href = `${searchPath}?q=${encodeURIComponent(query)}`;
        seeAllLink.classList.remove("hidden");
        seeAllLink.classList.add("flex");
      } else if (seeAllLink) {
        seeAllLink.classList.add("hidden");
        seeAllLink.classList.remove("flex");
      }
    }

    // Mobile menu
    const hamburgerBtn = document.getElementById("hamburger-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileBackdrop = document.getElementById("mobile-menu-backdrop");
    const hamburgerIcon = hamburgerBtn?.querySelector("i");
    const slider = mobileMenu?.querySelector(".mobile-menu-slider");

    function closeSubmenu() {
      slider?.classList.remove("submenu-open");
      (slider as HTMLElement | null)?.style.removeProperty("min-height");
      mobileMenu?.scrollTo(0, 0);
      slider
        ?.querySelectorAll(".mobile-submenu-panel")
        .forEach((p) => p.classList.remove("is-active"));
    }

    function openMobileMenu() {
      mobileMenu?.classList.remove("hidden");
      mobileBackdrop?.classList.remove("hidden");
      hamburgerIcon?.classList.replace("fa-bars", "fa-xmark");
      hamburgerBtn?.setAttribute("aria-expanded", "true");
      if (!navSearch?.classList.contains("hidden")) {
        closeSearch();
      }
    }

    function closeMobileMenu() {
      mobileMenu?.classList.add("hidden");
      mobileBackdrop?.classList.add("hidden");
      hamburgerIcon?.classList.replace("fa-xmark", "fa-bars");
      hamburgerBtn?.setAttribute("aria-expanded", "false");
      closeSubmenu();
    }

    function toggleMobileMenu() {
      if (mobileMenu?.classList.contains("hidden")) {
        openMobileMenu();
      } else {
        closeMobileMenu();
      }
    }

    hamburgerBtn?.addEventListener("click", toggleMobileMenu);
    mobileBackdrop?.addEventListener("click", closeMobileMenu);

    document.querySelectorAll(".mobile-menu-link").forEach((link) => {
      link.addEventListener("click", closeMobileMenu);
    });

    // Mobile submenu: slide to submenu panel
    document.querySelectorAll(".mobile-submenu-trigger").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = (btn as HTMLElement).dataset.submenu;
        const panel = slider?.querySelector(`[data-submenu-panel="${id}"]`);
        if (!panel || !slider) return;
        panel.classList.add("is-active");
        slider.classList.add("submenu-open");
        (slider as HTMLElement).style.minHeight = `${panel.scrollHeight}px`;
        mobileMenu?.scrollTo(0, 0);
      });
    });

    // Mobile submenu: back button slides back to main
    document.querySelectorAll(".mobile-back-btn").forEach((btn) => {
      btn.addEventListener("click", () => closeSubmenu());
    });

    // Event listeners
    openBtn?.addEventListener("click", () => {
      closeMobileMenu();
      openSearch();
    });
    closeBtn?.addEventListener("click", closeSearch);
    backdrop?.addEventListener("click", closeSearch);

    searchInput?.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        doSearch(searchInput.value);
      }, 200);
    });

    searchInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        navigateToSearch(searchInput.value);
      }
      if (e.key === "Escape") {
        closeSearch();
      }
    });

    // Ctrl/Cmd+K shortcut
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        if (navSearch?.classList.contains("hidden")) {
          openSearch();
        } else {
          closeSearch();
        }
      }
      if (e.key === "Escape") {
        if (!navSearch?.classList.contains("hidden")) {
          closeSearch();
        }
        if (!mobileMenu?.classList.contains("hidden")) {
          closeMobileMenu();
        }
      }
    });
  });
</script>
