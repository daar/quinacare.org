---
import { getLangFromUrl, useTranslations, type Lang } from "../i18n";

interface Props {
  lang?: Lang;
}

const lang = Astro.props.lang ?? getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const metrics = [
  {
    label: t("metrics.consultations"),
    value: "1.240",
    title: t("metrics.directMedical"),
    description: t("metrics.directMedicalDesc"),
  },
  {
    label: t("metrics.births"),
    value: "42",
    title: t("metrics.buildingFuture"),
    description: t("metrics.buildingFutureDesc"),
  },
  {
    label: t("metrics.medication"),
    value: "15k",
    title: t("metrics.jungleLogistics"),
    description: t("metrics.jungleLogisticsDesc"),
  },
];
---

<section class="bg-white border-y border-gray-100 font-arimo overflow-hidden">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex items-center gap-4 py-8">
      <div
        class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100"
      >
        <span class="relative flex h-2 w-2">
          <span
            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-qcRed opacity-75"
          ></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-qcRed"
          ></span>
        </span>
        <span
          class="text-[9px] font-bold uppercase tracking-[0.2em] text-qcBlack"
          >{t("metrics.liveData")}</span
        >
      </div>
      <div class="h-px flex-1 bg-gray-100"></div>
    </div>

    <div
      id="live-metrics"
      class="relative py-8 md:py-16 focus:outline-none"
      tabindex="0"
    >
      {/* Desktop: two columns */}
      <div class="hidden md:flex items-center gap-12">
        {/* Left column: metric counter */}
        <div class="w-1/2 flex items-center justify-between pr-12">
          <div class="relative h-28" id="metric-counter">
            {
              metrics.map((m, i) => (
                <div
                  class="metric-slide absolute inset-0 flex flex-col justify-center"
                  data-index={i}
                >
                  <span class="text-qcRed font-bold text-[10px] uppercase tracking-[0.3em] block mb-1">
                    {m.label}
                  </span>
                  <h2 class="text-6xl lg:text-8xl font-bold tracking-tighter leading-none">
                    {m.value}
                  </h2>
                </div>
              ))
            }
          </div>
          <div class="flex flex-col gap-2">
            {
              metrics.map((_, i) => (
                <div
                  class="metric-dot w-1 h-8 rounded-full transition-colors duration-500"
                  data-dot={i}
                />
              ))
            }
          </div>
        </div>

        {/* Right column: text content */}
        <div class="w-1/2">
          <div class="relative h-32">
            {
              metrics.map((m, i) => (
                <div
                  class="metric-text absolute inset-0 flex flex-col justify-center"
                  data-index={i}
                >
                  <h3 class="text-xl font-bold mb-4 uppercase tracking-tight">
                    {m.title}
                  </h3>
                  <p class="text-gray-500 text-base leading-relaxed max-w-sm">
                    {m.description}
                  </p>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      {/* Mobile: stacked */}
      <div class="md:hidden">
        {/* Counter on top */}
        <div class="relative h-24 mb-6" id="metric-counter-mobile">
          {
            metrics.map((m, i) => (
              <div
                class="metric-slide-mobile absolute inset-0 flex flex-col justify-center"
                data-index={i}
              >
                <span class="text-qcRed font-bold text-[10px] uppercase tracking-[0.3em] block mb-1">
                  {m.label}
                </span>
                <h2 class="text-5xl font-bold tracking-tighter leading-none">
                  {m.value}
                </h2>
              </div>
            ))
          }
        </div>

        {/* Text below */}
        <div class="relative h-28" id="metric-text-mobile">
          {
            metrics.map((m, i) => (
              <div
                class="metric-text-mobile absolute inset-0 flex flex-col justify-center"
                data-index={i}
              >
                <h3 class="text-lg font-bold mb-2 uppercase tracking-tight">
                  {m.title}
                </h3>
                <p class="text-gray-500 text-sm leading-relaxed">
                  {m.description}
                </p>
              </div>
            ))
          }
        </div>

        {/* Dots */}
        <div class="flex gap-2 mt-6">
          {
            metrics.map((_, i) => (
              <div
                class="metric-dot-mobile h-1 flex-1 rounded-full transition-colors duration-500"
                data-dot={i}
              />
            ))
          }
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const root = document.getElementById("live-metrics");
    if (!root) return;

    const INTERVAL = 5000;
    const WHEEL_COOLDOWN = 400;
    let active = 0;
    let timer: ReturnType<typeof setInterval>;

    const slides = root.querySelectorAll<HTMLElement>(".metric-slide");
    const texts = root.querySelectorAll<HTMLElement>(".metric-text");
    const dots = root.querySelectorAll<HTMLElement>(".metric-dot");
    const slidesMobile = root.querySelectorAll<HTMLElement>(
      ".metric-slide-mobile",
    );
    const textsMobile = root.querySelectorAll<HTMLElement>(
      ".metric-text-mobile",
    );
    const dotsMobile = root.querySelectorAll<HTMLElement>(".metric-dot-mobile");

    const TOTAL = slides.length;
    if (TOTAL === 0) return;

    function animateSlides(elements: NodeListOf<HTMLElement>, index: number) {
      elements.forEach((el, i) => {
        if (i === index) {
          el.style.opacity = "1";
          el.style.transform = "translateY(0) scale(1)";
        } else {
          el.style.opacity = "0";
          el.style.transform =
            i < index
              ? "translateY(-2rem) scale(0.95)"
              : "translateY(2rem) scale(0.95)";
        }
      });
    }

    function animateTexts(elements: NodeListOf<HTMLElement>, index: number) {
      elements.forEach((el, i) => {
        if (i === index) {
          el.style.opacity = "1";
          el.style.transform = "translateX(0)";
        } else {
          el.style.opacity = "0";
          el.style.transform =
            i < index ? "translateX(-1.5rem)" : "translateX(1.5rem)";
        }
      });
    }

    function activateDots(elements: NodeListOf<HTMLElement>, index: number) {
      elements.forEach((el, i) => {
        el.classList.toggle("bg-qcRed", i === index);
        el.classList.toggle("bg-gray-200", i !== index);
      });
    }

    function show(index: number) {
      active = index;
      animateSlides(slides, index);
      animateSlides(slidesMobile, index);
      animateTexts(texts, index);
      animateTexts(textsMobile, index);
      activateDots(dots, index);
      activateDots(dotsMobile, index);
    }

    function next() {
      show((active + 1) % TOTAL);
    }

    function prev() {
      show((active - 1 + TOTAL) % TOTAL);
    }

    function startTimer() {
      clearInterval(timer);
      timer = setInterval(next, INTERVAL);
    }

    // Scroll wheel: only preventDefault when actually advancing
    let wheelCooldown = false;
    root.addEventListener(
      "wheel",
      (e) => {
        if (wheelCooldown) return;
        e.preventDefault();
        wheelCooldown = true;

        if (e.deltaY > 0) next();
        else prev();

        startTimer();
        setTimeout(() => {
          wheelCooldown = false;
        }, WHEEL_COOLDOWN);
      },
      { passive: false },
    );

    // Pause timer when tab is hidden
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        clearInterval(timer);
      } else {
        startTimer();
      }
    });

    show(0);
    startTimer();
  });
</script>
